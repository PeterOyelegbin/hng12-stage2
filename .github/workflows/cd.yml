name: CD Pipeline

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    name: Deploy API
    runs-on: ubuntu-latest

    steps:
      - name: Display Deployment Trigger Information
        run: |
          echo "ðŸš€ Deployment triggered by a ${{ github.event_name }} event to the main branch."
          echo "ðŸ”„ Updating the deployed API with the latest changes."

      - name: Checkout Repository Code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_KP }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Connect to EC2 and Deploy API
        run: |
          echo "ðŸ”— Connecting to AWS EC2 instance to deploy API."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.SERVER }} << 'EOF'
            echo "ðŸ“‚ Updating package lists."
            sudo apt update
            
            echo "ðŸŒ Checking and Installing Nginx."
            if ! command -v nginx &> /dev/null; then
              echo "Installing Nginx..."
              sudo apt install -y nginx
              sudo systemctl enable nginx
              sudo systemctl start nginx
            fi

            echo "ðŸ“¦ Installing PIP and dependencies."
            sudo apt install python3-pip python3.12-venv -y

            echo "ðŸ“‚ Navigating to API directory."
            cd /usr/share/nginx/html

            echo "ðŸ”„ Pulling latest changes from repository."
            sudo git clone https://github.com/PeterOyelegbin/hng12-stage2.git
            cd hng12-stage2

            echo "ðŸ“¦ Creating and activating a virtual environment outside the Nginx folder."
            python3 -m venv /home/${{ secrets.USER }}/venv
            source /home/${{ secrets.USER }}/venv/bin/activate

            echo "ðŸ“¦ Installing project dependencies."
            pip install --no-cache-dir -r requirements.txt

            echo "ðŸ›  Configuring Nginx."
            sudo tee /etc/nginx/sites-available/default > /dev/null <<EOL
            server {
                listen 80;
                server_name yourdomain.com;

                location / {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                error_page 502 /502.html;
            }
            EOL

            echo "ðŸ”„ Restarting Nginx to apply changes."
            sudo systemctl restart nginx

            echo "ðŸš€ Starting Uvicorn server."
            nohup /home/${{ secrets.USER }}/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 &

          EOF

      - name: Confirm Deployment Status
        run: echo "âœ… Deployment completed successfully."
